#!/usr/bin/env bash

# Script for controlling postgres.
# Usage: `postgres.sh {up|down}`

postgres-up() {
  echo "Postgres - starting ${version}"
  pg_ctlcluster ${version} main start
}

postgres-down() {
  echo "Postgres - stopping ${version}"
  pg_ctlcluster ${version} main stop
}

postgres-status() {
  echo "Postgres - status of ${version}"
  pg_ctlcluster ${version} main status
}

postgres-clean() {
  if [ -n "${version}" ] ; then
    where="where pg_stat_activity.datname = '${version}';"
    echo "Postgres: killing all connections to database '${version}'"
  else
    where=";"
    echo "Postgres: killing all connections to all databases"
  fi

  cat <<-EOF | psql -U postgres -d postgres
  SELECT pg_terminate_backend(pg_stat_activity.pid)
  FROM pg_stat_activity ${where}
EOF
}

postgres-help() {
  echo "Usage: postgres {up|down|status|clean} [version]"
  exit 1
}

if [[ $1 != "clean" && $# != 2 ]]; then
  postgres-help
fi

version=$2

case $1 in
  "up") postgres-up ;;
  "down") postgres-down ;;
  "status") postgres-status ;;
  "clean") postgres-clean ;;
  "*") postgres-help ;;
esac
